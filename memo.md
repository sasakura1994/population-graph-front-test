## 現状

リファクタリングをしたいけどテストを書いていないのであんまりやりたくない。

テストを書きたい。Storybookで作ったコンポーネントでjestのテストを書きたい。Storybookではjest.mockが使えない。

apiを叩いているクラスをDIにする方法もあるけれどフロントエンドでDIすると見慣れない設計のせいで混乱を生むことがある。

mswはエンドポイントを知っていないといけないのであんまり設計的に好きではない(playwrightとかで使うならいいけど)。

環境変数でApiクラスを出し分けることにした。

調べてみたところSTORYBOOKなら`import.meta.env`が使えるしデフォルトで`import.meta.env.STORYBOOK === 'true'`となっているようなのでそれを使うことにした。

jestが`import.meta.env`を読み込めないのでmockした。密依存なので注意書きだけ書いておくことにした。

https://storybook.js.org/docs/react/configure/environment-variables




## このfeatureでやること

- [ ] APIの型とロジックを現状に合わせる
- [ ] ロジックを分離

画面の修正が必要だし、チェックした時点でということなら複数で叩く必要もないのでそちらの修正も行う。ついでなので型も変えよう。

課題をメモしておく。
## 課題
### 画面課題
- スマホ画面の見た目が悪い。
- モバイルでチェックボックスがサイズ的に押しやすいのかわからないしちょっとだけ実機で触ってみたい。
- 人口構成、取得出来ていたら二回目は取得しないようにしたい。
- 説明が無い。
  - タイトル入れる
  - 各セクションにタイトル入れる。アクセシビリティを意識したい。セクションコンポーネントでも作るか。

### グラフ課題
- Y軸の値、レスポンシブの時はもっと省略していいかも。
- Compositionという型の粒度はわかりづらいしboundaryYearもわかるようにしたい。
  - このグラフは信頼性が薄い。
  - 途中から折れ線をDashに返る方法があったのでそれを使ったりして表示したい。
- 切り替え実装してない。
  - これは一旦後にする。

## 前回からののメモ

今回のコミットとは関係ないけど「セキュリティを考慮してコードを記述」しようとしたらサーバーサイドで RESAS API を叩くしかなくない？vite でやったことないし nuxt に乗り換えようかな……。それか BASIC 認証入れるかか。CORS に引っかからなければ誰でも叩ける API(ただし API_KEY は漏れない)を置いておくのとユーザー名とパスワードを入れない限り叩けない API(ただし API_KEY はパスを入れたら見える)のどっちがマシかって話な気がしたけど、両方入れるのが正解だよな。うーん。とりあえず保留。

## TODO タスク
- [x] API 学習テスト
- [x] グラフライブラリ学習テスト
- [x] リクエスト回数が１秒平均 5 回らしいのでそれに注意して実装を行う必要がある
- [ ] プロトタイプの作成
  - [ ] 総人口を別の人口に切り替え
- [ ] API_KEY を見せたくない
- [ ] API を叩くクラスのエラー処理
